AWSTemplateFormatVersion: "2010-09-09"
Description: >-
  This creates the necessary components to deploy the Account Management
  Frontend onto ECS Fargate.
  Account Management Frontend can be invoked via the CloudFront Distribution,
  use the CloudFrontDistributionEndpoint URL exported by this stack.
  The ingress route in summary is:
  CloudFront -> WAF -> API Gateway -> VPC link -> Private ALB -> ECS Fargate
Transform:
  - AWS::Serverless-2016-10-31

# Must deploy the container on it's own first, having a successful cluster/container spun up
# Then only do we configure the blue/green deployment on the second run, not making any infrastructure related changes

#  - AWS::CodeDeployBlueGreen
#
#Hooks:
#  CodeDeployBlueGreenHook:
#    Properties:
#      TrafficRoutingConfig:
#        Type: TimeBasedCanary
#        TimeBasedCanary:
#          StepPercentage: 15
#          BakeTimeMins: 5
#      Applications:
#        - Target:
#            Type: AWS::ECS::Service
#            LogicalID: ContainerService
#          ECSAttributes:
#            TaskDefinitions:
#              - BlueTaskDefinition
#              - GreenTaskDefinition
#            TaskSets:
#              - BlueTaskSet
#              - GreenTaskSet
#            TrafficRouting:
#              ProdTrafficRoute:
#                Type: AWS::ElasticLoadBalancingV2::Listener
#                LogicalID: ApplicationLoadBalancerListenerHTTPS
#              TargetGroups:
#                - ApplicationLoadBalancerTargetGroupBlue
#                - ApplicationLoadBalancerTargetGroupGreen
#    Type: AWS::CodeDeploy::BlueGreen

Parameters:
  Environment:
    Description: The name of the environment to deploy to
    Type: String
    AllowedValues:
      - "dev"
      - "build"
      - "staging"
      - "integration"
      - "production"
  VpcStackName:
    Description: The name of the stack that defines the VPC in which this container will run.
    Type: String
  RedisStackName:
    Description: The name of the stack that defines the Redis cluster
    Type: String
    Default: shared-redis
  BackendStackName:
    Description: The name of the backend stack
    Type: String
    Default: account-mgmt-backend
  ContainerPort:
    Description: The port on which the container is running
    Type: Number
    Default: 6001
  ECSClusterMaxCapacity:
    Description: The maximum capacity of the ECS Cluster Auto Scaling Target
    Type: Number
    Default: 6
  ProductTagValue:
    Description: Value for the Product Tag
    Type: String
    Default: GOV.UK Sign In
  OwnerTagValue:
    Description: Value for the Owner Tag
    Type: String
    Default: govuk-accounts-tech@digital.cabinet-office.gov.uk
  SourceTagValue:
    Description: Value for the Source Tag
    Type: String
    Default: alphagov/di-authentication-account-management/deploy/template.yaml
  SystemTagValue:
    Description: Value for the System Tag
    Type: String
    Default: Accounts
  PermissionsBoundary:
    Description: The ARN of the permissions boundary to apply when creating IAM roles
    Type: String
    Default: none

Conditions:
  IsProduction: !Equals [!Ref Environment, production]
  UsePermissionsBoundary:
    Fn::Not:
      - Fn::Equals:
          - !Ref PermissionsBoundary
          - "none"

Mappings:
  # see https://docs.aws.amazon.com/elasticloadbalancing/latest/application/load-balancer-access-logs.html
  ElasticLoadBalancerAccountIds:
    eu-west-2:
      AccountId: 652711504416
  EnvironmentVariables:
    ### These environment variables are referenced further down the file.
    ### Please ensure that any variables defined for an environment are defined for _all_ environments.
    dev:
      NODEENV: "production"
      APIBASEURL: "https://oidc.staging.account.gov.uk"
      AMAPIBASEURL: "https://manage.staging.account.gov.uk"
      BASEURL: "home.dev.account.gov.uk"
      SESSIONEXPIRY: "7200000"
      AMYOURACCOUNTURL: "https://www.staging.publishing.service.gov.uk/account/home"
      GOVACCOUNTSPUBLISHINGAPIURL: "account-api.staging.publishing.service.gov.uk"
      SUPPORTINTERNATIONALNUMBERS: "0"
      SUPPORTLANGUAGECY: "1"
      SUPPORTNEWACCOUNTHEADER: "1"
      SUPPORTDELETESERVICESTORE: "1"
      SUPPORTSERVICECARDS: "0"
      AUTHFRONTENDURL: "signin.staging.account.gov.uk"
      ANALYTICSCOOKIEDOMAIN: "dev.account.gov.uk"
      SERVICEDOMAIN: "dev.account.gov.uk"
      LOGSLEVEL: "debug"
    build:
      NODEENV: "production"
      APIBASEURL: "https://oidc.build.account.gov.uk"
      AMAPIBASEURL: "https://manage.build.account.gov.uk"
      BASEURL: "home.build.account.gov.uk"
      SESSIONEXPIRY: "7200000"
      AMYOURACCOUNTURL: "https://www.staging.publishing.service.gov.uk/account/home"
      GOVACCOUNTSPUBLISHINGAPIURL: "account-api.staging.publishing.service.gov.uk"
      SUPPORTINTERNATIONALNUMBERS: "0"
      SUPPORTLANGUAGECY: "1"
      SUPPORTNEWACCOUNTHEADER: "1"
      SUPPORTDELETESERVICESTORE: "0"
      SUPPORTSERVICECARDS: "0"
      AUTHFRONTENDURL: "signin.build.account.gov.uk"
      ANALYTICSCOOKIEDOMAIN: "build.account.gov.uk"
      SERVICEDOMAIN: "build.account.gov.uk"
      LOGSLEVEL: "debug"
    staging:
      NODEENV: "production"
      APIBASEURL: "https://oidc.staging.account.gov.uk"
      AMAPIBASEURL: "https://manage.staging.account.gov.uk"
      BASEURL: "home.staging.account.gov.uk"
      SESSIONEXPIRY: "7200000"
      AMYOURACCOUNTURL: "https://www.staging.publishing.service.gov.uk/account/home"
      GOVACCOUNTSPUBLISHINGAPIURL: "account-api.staging.publishing.service.gov.uk"
      SUPPORTINTERNATIONALNUMBERS: "0"
      SUPPORTLANGUAGECY: "1"
      SUPPORTNEWACCOUNTHEADER: "1"
      SUPPORTDELETESERVICESTORE: "0"
      SUPPORTSERVICECARDS: "0"
      AUTHFRONTENDURL: "signin.staging.account.gov.uk"
      ANALYTICSCOOKIEDOMAIN: "staging.account.gov.uk"
      SERVICEDOMAIN: "staging.account.gov.uk"
      LOGSLEVEL: "info"
    integration:
      NODEENV: "production"
      APIBASEURL: "https://oidc.integration.account.gov.uk"
      AMAPIBASEURL: "https://manage.integration.account.gov.uk"
      BASEURL: "home.integration.account.gov.uk"
      SESSIONEXPIRY: "7200000"
      AMYOURACCOUNTURL: "https://www.integration.publishing.service.gov.uk/account/home"
      GOVACCOUNTSPUBLISHINGAPIURL: "account-api.integration.publishing.service.gov.uk"
      SUPPORTINTERNATIONALNUMBERS: "0"
      SUPPORTLANGUAGECY: "1"
      SUPPORTNEWACCOUNTHEADER: "0"
      SUPPORTDELETESERVICESTORE: "0"
      SUPPORTSERVICECARDS: "0"
      AUTHFRONTENDURL: "signin.integration.account.gov.uk"
      ANALYTICSCOOKIEDOMAIN: "integration.account.gov.uk"
      SERVICEDOMAIN: "integration.account.gov.uk"
      LOGSLEVEL: "info"
    production:
      NODEENV: "production"
      APIBASEURL: "https://oidc.account.gov.uk"
      AMAPIBASEURL: "https://manage.account.gov.uk"
      BASEURL: "home.account.gov.uk"
      SESSIONEXPIRY: "7200000"
      AMYOURACCOUNTURL: "https://www.gov.uk/account/home"
      GOVACCOUNTSPUBLISHINGAPIURL: "account-api.publishing.service.gov.uk"
      SUPPORTINTERNATIONALNUMBERS: "0"
      SUPPORTLANGUAGECY: "1"
      SUPPORTNEWACCOUNTHEADER: "0"
      SUPPORTDELETESERVICESTORE: "0"
      SUPPORTSERVICECARDS: "0"
      AUTHFRONTENDURL: "signin.account.gov.uk"
      ANALYTICSCOOKIEDOMAIN: "account.gov.uk"
      SERVICEDOMAIN: "account.gov.uk"
      LOGSLEVEL: "info"

Resources:
  #
  # ECS Service
  #

  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub "${AWS::StackName}-ECSCluster"
      CapacityProviders:
        - FARGATE
      ClusterSettings:
        - Name: containerInsights
          Value: enabled
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ECSCluster"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue
    DependsOn: ApplicationLoadBalancerListenerHTTPS

  ExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-ExecutionRole"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      ManagedPolicyArns:
        - "arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy"
      Policies:
        - PolicyName: PullImage
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "logs:CreateLogStream"
                  - "logs:PutLogEvents"
                Resource:
                  - !GetAtt TaskLogGroup.Arn
                  - !Sub "${TaskLogGroup.Arn}:*"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ExecutionRole"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  TaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub "${AWS::StackName}-TaskRole"
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Sub "${AWS::StackName}-TaskRolePolicy"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - "sns:Publish"
                Resource:
                  - !Sub "arn:aws:sns:${AWS::Region}:${AWS::AccountId}:UserAccountDeletion"
              - Effect: Allow
                Action:
                  - "ssm:GetParameters"
                Resource:
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${AWS::StackName}/*"
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RedisStackName}/Cluster/*" # for the future when no legacy
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${Environment}-${RedisStackName}-redis-*" # for access to legacy params
                  - !Sub "arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${BackendStackName}/SNS/DeleteTopic/ARN"
              - Effect: Allow
                Action:
                  - "secretsmanager:GetSecretValue"
                Resource:
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:/${AWS::StackName}/Config/Publishing/API/Key"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:/${AWS::StackName}/Config/Session/Secret"
                  - !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:/${RedisStackName}/Cluster/Password"
              - Effect: Allow
                Action:
                  - "kms:Sign"
                  - "kms:GetPublicKey"
                Resource: !Join
                  - ""
                  - - !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/"
                    - !Sub "{{resolve:ssm:/${AWS::StackName}/KMS/JwtSigningKey/Id}}"
              - Effect: Allow
                Action:
                  - "kms:GenerateDataKey*"
                  - "kms:Decrypt"
                Resource:
                  - !Sub "arn:aws:kms:${AWS::Region}:${AWS::AccountId}:key/{{resolve:ssm:/${BackendStackName}/KMS/SnsKmsKey/ID}}"
      PermissionsBoundary: !If
        - UsePermissionsBoundary
        - !Ref PermissionsBoundary
        - !Ref AWS::NoValue
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-TaskRole"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ECSClusterNameParameter:
    Type: AWS::SSM::Parameter
    Properties:
      Description: !Sub "The name of the ${AWS::StackName} ECS cluster"
      Name: !Sub "/${AWS::StackName}/ECS/Cluster"
      Type: String
      Value: !Ref ECSCluster
      Tags:
        Product: !Ref ProductTagValue
        System: !Ref SystemTagValue
        Environment: !Ref Environment
        Owner: !Ref OwnerTagValue
        Source: !Ref SourceTagValue

  ContainerService:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref ECSCluster
      DeploymentController:
        Type: EXTERNAL
      PropagateTags: SERVICE
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ContainerService"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue
    DependsOn: ApplicationLoadBalancerListenerHTTPS

  ContainerServiceSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: !Sub "Security Group to access the ${AWS::StackName} Container Service"
      GroupName: !Join
        - "-"
        - - !Ref AWS::StackName
          - ContainerService
          - Fn::Select:
              - 4
              - Fn::Split:
                  - "-"
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - "/"
                          - Ref: AWS::StackId
      SecurityGroupIngress:
        - Description: !Sub "Allow traffic from the load balancer on port ${ContainerPort}"
          SourceSecurityGroupId: !GetAtt ApplicationLoadBalancerSecurityGroup.GroupId
          IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
      VpcId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcId"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ContainerServiceSecurityGroup"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  #
  # Fargate tasks
  #

  BlueTaskDefinition:
    Type: AWS::ECS::TaskDefinition
    Properties:
      ContainerDefinitions:
        - Essential: true
          Image: "CONTAINER-IMAGE-PLACEHOLDER"
          Name: !Sub "${AWS::StackName}-BlueTaskDefinition"
          PortMappings:
            - ContainerPort: !Ref ContainerPort
              Protocol: tcp
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref TaskLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: "ecs"
          Environment:
            - Name: "NODE_ENV"
              Value:
                !FindInMap [EnvironmentVariables, !Ref Environment, NODEENV]
            - Name: "APP_ENV"
              Value: !Sub "${Environment}"
            - Name: "API_BASE_URL"
              Value:
                !FindInMap [EnvironmentVariables, !Ref Environment, APIBASEURL]
            - Name: "AM_API_BASE_URL"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  AMAPIBASEURL,
                ]
            - Name: "BASE_URL"
              Value:
                !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
            - Name: "OIDC_CLIENT_ID"
              Value: !Sub "{{resolve:ssm:/${AWS::StackName}/Config/OIDC/Client/Id}}"
            - Name: "OIDC_CLIENT_SCOPES"
              Value: "openid phone email am offline_access govuk-account"
            - Name: "SESSION_EXPIRY"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SESSIONEXPIRY,
                ]
            - Name: "SESSION_SECRET"
              Value: !Sub "{{resolve:secretsmanager:${SessionSecret}}}"
            - Name: "AM_YOUR_ACCOUNT_URL"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  AMYOURACCOUNTURL,
                ]
            - Name: "GTM_ID"
              Value: !Sub "{{resolve:ssm:/${AWS::StackName}/Config/GTM/Id}}"
            - Name: "GOV_ACCOUNTS_PUBLISHING_API_URL"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  GOVACCOUNTSPUBLISHINGAPIURL,
                ]
            - Name: "GOV_ACCOUNTS_PUBLISHING_API_TOKEN"
              Value: !Sub "{{resolve:secretsmanager:/${AWS::StackName}/Config/Publishing/API/Key}}"
            - Name: "SUPPORT_INTERNATIONAL_NUMBERS"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SUPPORTINTERNATIONALNUMBERS,
                ]
            - Name: "SUPPORT_LANGUAGE_CY"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SUPPORTLANGUAGECY,
                ]
            - Name: "SUPPORT_NEW_ACCOUNT_HEADER"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SUPPORTNEWACCOUNTHEADER,
                ]
            - Name: "SUPPORT_DELETE_SERVICE_STORE"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SUPPORTDELETESERVICESTORE,
                ]
            - Name: "SUPPORT_SERVICE_CARDS"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SUPPORTSERVICECARDS,
                ]
            - Name: "AUTH_FRONTEND_URL"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  AUTHFRONTENDURL,
                ]
            - Name: "ANALYTICS_COOKIE_DOMAIN"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  ANALYTICSCOOKIEDOMAIN,
                ]
            - Name: "REDIS_KEY"
              Value: !Ref RedisStackName
            - Name: "KMS_KEY_ID"
              Value: !Sub "{{resolve:ssm:/${AWS::StackName}/KMS/JwtSigningKey/Id}}"
            - Name: "SERVICE_DOMAIN"
              Value:
                !FindInMap [
                  EnvironmentVariables,
                  !Ref Environment,
                  SERVICEDOMAIN,
                ]
            - Name: "LOGS_LEVEL"
              Value:
                !FindInMap [EnvironmentVariables, !Ref Environment, LOGSLEVEL]
            - Name: "DELETE_TOPIC_ARN"
              Value: !Sub "{{resolve:ssm:/${BackendStackName}/SNS/DeleteTopic/ARN}}"
      Cpu: 1024
      Memory: 2048
      ExecutionRoleArn: !GetAtt ExecutionRole.Arn
      TaskRoleArn: !GetAtt TaskRole.Arn
      Family: !Sub "${AWS::StackName}-BlueTaskDefinition"
      NetworkMode: awsvpc
      RequiresCompatibilities:
        - FARGATE
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-BlueTaskDefinition"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue
    DependsOn: SessionSecret

  TaskLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/ecs/${AWS::StackName}/server"
      RetentionInDays: 1
      KmsKeyId: !GetAtt LoggingKmsKey.Arn

  TaskLogGroupCSLSSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref TaskLogGroup

  SessionSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub "/${AWS::StackName}/Config/Session/Secret"
      Description: !Sub Random password for the ${AWS::StackName} session secret
      GenerateSecretString:
        ExcludeLowercase: false
        ExcludeNumbers: false
        ExcludePunctuation: true
        ExcludeUppercase: false
        IncludeSpace: false
        RequireEachIncludedType: true
        PasswordLength: 32
      KmsKeyId: !GetAtt SecretsKmsKey.Arn
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-SessionSecret"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  SecretsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub "KMS key used to protect secrets data in ${AWS::StackName}"
      Enabled: true
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "secretsmanager.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                aws:SourceArn: !Sub "arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:/${AWS::StackName}/Config/Session/Secret"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-SecretsKmsKey"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  SecretsKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-SecretsKmsKey"
      TargetKeyId: !GetAtt SecretsKmsKey.Arn

  #
  # API Gateway
  #

  ApiGateway:
    Type: AWS::ApiGatewayV2::Api
    Properties:
      Name: !Sub "${AWS::StackName}-Api"
      ProtocolType: HTTP
      Tags:
        Product: !Ref ProductTagValue
        System: !Ref SystemTagValue
        Environment: !Ref Environment
        Name: !Sub "${AWS::StackName}-ApiGateway"
        Owner: !Ref OwnerTagValue
        Source: !Ref SourceTagValue

  ApiGatewayIntegration:
    Type: AWS::ApiGatewayV2::Integration
    Properties:
      ApiId: !Ref ApiGateway
      IntegrationType: HTTP_PROXY
      ConnectionId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcLinkId"
      ConnectionType: VPC_LINK
      IntegrationMethod: ANY
      IntegrationUri: !Ref ApplicationLoadBalancerListenerHTTPS
      PayloadFormatVersion: 1.0
      Description: !Sub "API GW to ECS Container integration for ${AWS::StackName}"
      TlsConfig:
        ServerNameToVerify:
          !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]

  ApiRoute:
    Type: AWS::ApiGatewayV2::Route
    Properties:
      ApiId: !Ref ApiGateway
      RouteKey: "ANY /{proxy+}"
      Target: !Sub "integrations/${ApiGatewayIntegration}"

  ApiDefaultStage:
    Type: AWS::ApiGatewayV2::Stage
    Properties:
      ApiId: !Ref ApiGateway
      StageName: "$default"
      AutoDeploy: true
      AccessLogSettings:
        Format: "$context.requestId $context.httpMethod $context.path"
        DestinationArn: !GetAtt ApiGatewayAccessLogGroup.Arn
      Tags:
        Product: !Ref ProductTagValue
        System: !Ref SystemTagValue
        Environment: !Ref Environment
        Name: !Sub "${AWS::StackName}-ApiDefaultStage"
        Owner: !Ref OwnerTagValue
        Source: !Ref SourceTagValue

  #
  # App domain
  #
  AppFrontCustomDomain:
    Type: AWS::ApiGatewayV2::DomainName
    Properties:
      DomainName: !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
      DomainNameConfigurations:
        - CertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/HostedZone/Certificate/Home/ARN}}"
          EndpointType: REGIONAL
          SecurityPolicy: TLS_1_2
      Tags:
        Product: !Ref ProductTagValue
        System: !Ref SystemTagValue
        Environment: !Ref Environment
        Owner: !Ref OwnerTagValue
        Source: !Ref SourceTagValue

  AppFrontApiRecord:
    Type: AWS::Route53::RecordSet
    Properties:
      Name: !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
      Type: A
      HostedZoneId: !Sub "{{resolve:ssm:/${Environment}/Platform/Route53/HostedZone/Home}}"
      AliasTarget:
        DNSName: !GetAtt CloudFrontDistribution.DomainName
        # see https://docs.aws.amazon.com/AWSCloudFormation/latest/UserGuide/aws-properties-route53-aliastarget.html#cfn-route53-aliastarget-hostedzoneid
        HostedZoneId: "Z2FDTNDATAQYW2"
        EvaluateTargetHealth: false

  AppFrontApiMapping:
    Type: AWS::ApiGatewayV2::ApiMapping
    Properties:
      DomainName: !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
      ApiId: !Ref ApiGateway
      Stage: !Ref ApiDefaultStage
    DependsOn:
      - AppFrontCustomDomain

  #
  # Load balancing
  #

  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Scheme: internal
      Type: application
      SecurityGroups:
        - !GetAtt ApplicationLoadBalancerSecurityGroup.GroupId
      Subnets:
        - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
        - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      LoadBalancerAttributes:
        - Key: access_logs.s3.enabled
          Value: true
        - Key: access_logs.s3.bucket
          Value: !Ref AccessLogsBucket
        - Key: routing.http.drop_invalid_header_fields.enabled
          Value: true
        - !Ref AWS::NoValue
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ApplicationLoadBalancer"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ApplicationLoadBalancerTargetGroupBlue:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckPort: !Ref ContainerPort
      HealthCheckProtocol: HTTP
      HealthCheckPath: /healthcheck
      HealthCheckIntervalSeconds: 30
      Port: !Ref ContainerPort
      Protocol: HTTP
      ProtocolVersion: HTTP1
      Matcher:
        HttpCode: "200"
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcId"
      TargetGroupAttributes:
        - Key: "deregistration_delay.timeout_seconds"
          Value: "5"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ApplicationLoadBalancerTargetGroupBlue"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ApplicationLoadBalancerTargetGroupGreen:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      HealthCheckPort: !Ref ContainerPort
      HealthCheckProtocol: HTTP
      HealthCheckPath: /healthcheck
      HealthCheckIntervalSeconds: 30
      Port: !Ref ContainerPort
      Protocol: HTTP
      ProtocolVersion: HTTP1
      Matcher:
        HttpCode: "200"
      TargetType: ip
      UnhealthyThresholdCount: 2
      VpcId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcId"
      TargetGroupAttributes:
        - Key: "deregistration_delay.timeout_seconds"
          Value: "5"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ApplicationLoadBalancerTargetGroupGreen"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ApplicationLoadBalancerListenerHTTPS:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      DefaultActions:
        - TargetGroupArn: !Ref ApplicationLoadBalancerTargetGroupBlue
          Type: forward
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/HostedZone/Certificate/Home/ARN}}"
      SslPolicy: "ELBSecurityPolicy-FS-1-2-Res-2020-10"

  ApplicationLoadBalancerListenerHTTP:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      # checkov:skip=CKV_AWS_2: Ignored as this is only redirects HTTP to HTTPS.
      # checkov:skip=CKV_AWS_103: Ignored as only redirects HTTP to HTTPS.
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Port: 443
            Protocol: HTTPS
            StatusCode: HTTP_301
      LoadBalancerArn: !Ref ApplicationLoadBalancer
      Port: 80
      Protocol: HTTP

  ApplicationLoadBalancerListenerRuleRobots:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      Actions:
        - Type: fixed-response
          FixedResponseConfig:
            ContentType: text/plain
            MessageBody: >
              "user-agent: *"
              "disallow: /"
            StatusCode: 200
      Conditions:
        - Field: path-pattern
          PathPatternConfig:
            Values:
              - "/robots.txt"
      ListenerArn: !Ref ApplicationLoadBalancerListenerHTTPS
      Priority: 10

  BlueTaskSet:
    Type: AWS::ECS::TaskSet
    Properties:
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsVpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !GetAtt ContainerServiceSecurityGroup.GroupId
          Subnets:
            - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdA"
            - Fn::ImportValue: !Sub "${VpcStackName}-ProtectedSubnetIdB"
      PlatformVersion: 1.4.0
      Scale:
        Unit: PERCENT
        Value: 100
      Service: !Ref ContainerService
      TaskDefinition: !Ref BlueTaskDefinition
      LoadBalancers:
        - ContainerName: !Sub "${AWS::StackName}-BlueTaskDefinition"
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref ApplicationLoadBalancerTargetGroupBlue

  PrimaryTaskSet:
    Type: AWS::ECS::PrimaryTaskSet
    Properties:
      Cluster: !Ref ECSCluster
      Service: !Ref ContainerService
      TaskSetId: !GetAtt
        - BlueTaskSet
        - Id

  ApplicationLoadBalancerSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security Group for the Application Load Balancer
      GroupName: !Join
        - "-"
        - - !Ref AWS::StackName
          - ApplicationLoadBalancer
          - Fn::Select:
              - 4
              - Fn::Split:
                  - "-"
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - "/"
                          - Ref: AWS::StackId
      VpcId:
        Fn::ImportValue: !Sub "${VpcStackName}-VpcId"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-ApplicationLoadBalancerSecurityGroup"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ApplicationLoadBalancerSecurityGroupIngressHTTP:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt ApplicationLoadBalancerSecurityGroup.GroupId
      CidrIp: 0.0.0.0/0
      Description: Allows HTTP traffic from anyone on port 80
      IpProtocol: tcp
      FromPort: 80
      ToPort: 80

  ApplicationLoadBalancerSecurityGroupIngressHTTPS:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      GroupId: !GetAtt ApplicationLoadBalancerSecurityGroup.GroupId
      CidrIp: 0.0.0.0/0
      Description: Allows HTTPS traffic from anyone on port 443
      IpProtocol: tcp
      FromPort: 443
      ToPort: 443

  ApplicationLoadBalancerSecurityGroupEgress:
    Type: AWS::EC2::SecurityGroupEgress
    Properties:
      GroupId: !GetAtt ApplicationLoadBalancerSecurityGroup.GroupId
      DestinationSecurityGroupId: !GetAtt ContainerServiceSecurityGroup.GroupId
      Description: !Sub "Allow traffic to Container Service on port ${ContainerPort}"
      IpProtocol: tcp
      FromPort: !Ref ContainerPort
      ToPort: !Ref ContainerPort

  #
  # Autoscaling
  #

  ECSAutoScalingTarget:
    Condition: IsProduction
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref ECSClusterMaxCapacity
      MinCapacity: 2
      ResourceId: !Join
        - "/"
        - - "service"
          - !Ref ECSCluster
          - !GetAtt ContainerService.Name
      RoleARN: !Sub "arn:aws:iam::${AWS::AccountId}:role/aws-service-role/ecs.application-autoscaling.amazonaws.com/AWSServiceRoleForApplicationAutoScaling_ECSService"
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  ECSAutoScalingPolicyMemory:
    Condition: IsProduction
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${AWS::StackName}-ECSAutoScalingPolicyMemory"
      PolicyType: TargetTrackingScaling
      ResourceId: !Join
        - "/"
        - - "service"
          - !Ref ECSCluster
          - !GetAtt ContainerService.Name
      ScalableDimension: "ecs:service:DesiredCount"
      ServiceNamespace: "ecs"
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: "ECSServiceAverageMemoryUtilization"
        TargetValue: 75.0
    DependsOn: ECSAutoScalingTarget

  ECSAutoScalingPolicyCPU:
    Condition: IsProduction
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub "${AWS::StackName}-ECSAutoScalingPolicyCPU"
      PolicyType: TargetTrackingScaling
      ResourceId: !Join
        - "/"
        - - "service"
          - !Ref ECSCluster
          - !GetAtt ContainerService.Name
      ScalableDimension: "ecs:service:DesiredCount"
      ServiceNamespace: "ecs"
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: "ECSServiceAverageCPUUtilization"
        TargetValue: 65.0
    DependsOn: ECSAutoScalingTarget

  #
  # Logging
  #

  ApiGatewayAccessLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub "/apigateway/${AWS::StackName}/access"
      RetentionInDays: 1
      KmsKeyId: !GetAtt LoggingKmsKey.Arn
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: ApiGatewayAccessLogGroup
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  ApiGatewayAccessLogGroupCSLSSubscription:
    Type: AWS::Logs::SubscriptionFilter
    Properties:
      DestinationArn: !Sub "{{resolve:ssm:/${Environment}/Platform/Logs/Subscription/CSLS/ARN}}"
      FilterPattern: ""
      LogGroupName: !Ref ApiGatewayAccessLogGroup

  LoggingKmsKey:
    Type: AWS::KMS::Key
    Properties:
      EnableKeyRotation: true
      KeyPolicy:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              AWS: !Sub "arn:aws:iam::${AWS::AccountId}:root"
            Action:
              - kms:*
            Resource: "*"
          - Effect: Allow
            Principal:
              Service: !Sub "logs.${AWS::Region}.amazonaws.com"
            Action:
              - "kms:Encrypt*"
              - "kms:Decrypt*"
              - "kms:ReEncrypt*"
              - "kms:GenerateDataKey*"
              - "kms:Describe*"
            Resource: "*"
            Condition:
              ArnLike:
                "kms:EncryptionContext:aws:logs:arn":
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/${AWS::StackName}/server"
                  - !Sub "arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/apigateway/${AWS::StackName}/access"
      Tags:
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Name
          Value: !Sub "${AWS::StackName}-LoggingKmsKey"
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  LoggingKmsKeyAlias:
    Type: AWS::KMS::Alias
    Properties:
      AliasName: !Sub "alias/${AWS::StackName}-LoggingKmsKey"
      TargetKeyId: !GetAtt LoggingKmsKey.Arn

  AccessLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      # checkov:skip=CKV_AWS_18:This is the access logs bucket. It should not log itself.
      BucketName: !Join
        - "-"
        - - !Ref AWS::StackName
          - logs
          - Fn::Select:
              - 4
              - Fn::Split:
                  - "-"
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - /
                          - Ref: AWS::StackId
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-AccessLogs"
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue
        - Key: CheckovRulesToSkip
          Value: CKV_AWS_18

  AccessLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref AccessLogsBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AllowLoadBalancerToLogToS3
            Effect: Allow
            Principal:
              AWS: !Sub
                - "arn:aws:iam::${ElbAccountId}:root"
                - ElbAccountId:
                    !FindInMap [
                      ElasticLoadBalancerAccountIds,
                      !Ref AWS::Region,
                      AccountId,
                    ]
            Action:
              - s3:PutObject
            Resource: !Sub "${AccessLogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              Bool:
                "aws:SecureTransport": true
          - Sid: AllowAwsLogDeliveryToLogToS3
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action:
              - s3:PutObject
            Resource: !Sub "${AccessLogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": bucket-owner-full-control
                "aws:SourceAccount": !Ref AWS::AccountId
              Bool:
                "aws:SecureTransport": true
          - Sid: AllowAwsLogDeliveryToReadBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action:
              - s3:GetBucketAcl
            Resource: !GetAtt AccessLogsBucket.Arn
            Condition:
              StringEquals:
                "aws:SourceAccount": !Ref AWS::AccountId
              Bool:
                "aws:SecureTransport": true

  #
  # CloudFront Distribution
  #

  CloudFrontDistribution:
    Type: AWS::CloudFront::Distribution
    DependsOn: CloudFrontLogsBucket
    Properties:
      DistributionConfig:
        Aliases:
          - !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
        CNAMEs:
          - !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
        Comment: !Sub "CloudFront Distribution resource for the ${AWS::StackName} application"
        DefaultCacheBehavior:
          AllowedMethods:
            - GET
            - HEAD
            - OPTIONS
            - PUT
            - PATCH
            - POST
            - DELETE
          CachedMethods:
            - GET
            - HEAD
          # CachingDisabled managed cache policy id
          # see https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/using-managed-cache-policies.html#managed-cache-policies-list
          CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
          OriginRequestPolicyId: !GetAtt CloudFrontOriginRequestPolicy.Id
          Compress: false
          MinTTL: 0
          TargetOriginId:
            !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
          ViewerProtocolPolicy: redirect-to-https
        Enabled: true
        HttpVersion: "http2"
        Logging:
          Bucket: !Sub "${CloudFrontLogsBucket}.s3.amazonaws.com"
        Origins:
          - ConnectionAttempts: 3
            ConnectionTimeout: 10
            DomainName: !Sub "${ApiGateway}.execute-api.${AWS::Region}.amazonaws.com"
            Id: !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
            CustomOriginConfig:
              HTTPSPort: 443
              OriginKeepaliveTimeout: 5
              OriginProtocolPolicy: https-only
              OriginReadTimeout: 30
              OriginSSLProtocols:
                - TLSv1.2
        ViewerCertificate:
          AcmCertificateArn: !Sub "{{resolve:ssm:/${Environment}/Platform/ACM/Global/Certificate/Home/ARN}}"
          MinimumProtocolVersion: TLSv1.2_2021
          SslSupportMethod: sni-only
        WebACLId: !Sub "{{resolve:ssm:/${Environment}/Platform/WAF/Global/ACL/ARN}}"
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-CloudFrontDistribution"
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue

  CloudFrontOriginRequestPolicy:
    Type: AWS::CloudFront::OriginRequestPolicy
    Properties:
      OriginRequestPolicyConfig:
        Comment: String
        CookiesConfig:
          CookieBehavior: all
        HeadersConfig:
          HeaderBehavior: allViewer
        Name: !Sub "${AWS::StackName}-OriginRequestPolicy"
        QueryStringsConfig:
          QueryStringBehavior: all

  CloudFrontLogsBucket:
    Type: AWS::S3::Bucket
    Properties:
      # checkov:skip=CKV_AWS_18:This is the access logs bucket. It should not log itself.
      OwnershipControls:
        Rules:
          - ObjectOwnership: BucketOwnerPreferred
      BucketName: !Join
        - "-"
        - - !Ref AWS::StackName
          - cloudfront
          - Fn::Select:
              - 4
              - Fn::Split:
                  - "-"
                  - Fn::Select:
                      - 2
                      - Fn::Split:
                          - /
                          - Ref: AWS::StackId
      VersioningConfiguration:
        Status: Enabled
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      Tags:
        - Key: Name
          Value: !Sub "${AWS::StackName}-AccessLogs"
        - Key: Product
          Value: !Ref ProductTagValue
        - Key: System
          Value: !Ref SystemTagValue
        - Key: Environment
          Value: !Ref Environment
        - Key: Owner
          Value: !Ref OwnerTagValue
        - Key: Source
          Value: !Ref SourceTagValue
        - Key: CheckovRulesToSkip
          Value: CKV_AWS_18

  CloudFrontLogsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref CloudFrontLogsBucket
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Sid: AllowAwsLogDeliveryToLogToS3
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action:
              - s3:PutObject
            Resource: !Sub "${CloudFrontLogsBucket.Arn}/AWSLogs/${AWS::AccountId}/*"
            Condition:
              StringEquals:
                "s3:x-amz-acl": bucket-owner-full-control
                "aws:SourceAccount": !Ref AWS::AccountId
              Bool:
                "aws:SecureTransport": true
          - Sid: AllowAwsLogDeliveryToReadBucketAcl
            Effect: Allow
            Principal:
              Service: delivery.logs.amazonaws.com
            Action:
              - s3:GetBucketAcl
            Resource: !GetAtt CloudFrontLogsBucket.Arn
            Condition:
              StringEquals:
                "aws:SourceAccount": !Ref AWS::AccountId
              Bool:
                "aws:SecureTransport": true

  #
  # Outputs
  #

Outputs:
  ApiGatewayEndpoint:
    Description: The URL for the application's API Gateway.
    Value: !GetAtt ApiGateway.ApiEndpoint
  CloudFrontDistributionEndpoint:
    Description: The Application URL.
    Value: !FindInMap [EnvironmentVariables, !Ref Environment, BASEURL]
