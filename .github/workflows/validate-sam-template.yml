---
name: Validate SAM Template

# Triggered when:
#   - a file, listed below, is pushed to any branch other than `main`, i.e. a feature branch.
#   - invoked by another workflow.
on:
  push:
    paths:
      - "deploy/template.yaml"
      - "deploy/.samconfig.toml"
      - ".github/workflows/validate-sam-template.yml"
    branches-ignore:
      - main
  workflow_call:

jobs:
  validate_sam_template:
    name: SAM Checks
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    env:
      SAM_CLI_TELEMETRY: 0
      ENVIRONMENT: build
    steps:
      - uses: actions/checkout@v3
      - name: Set up Python 3.8
        uses: actions/setup-python@v2
        with:
          python-version: "3.8"

      - name: Set up SAM cli
        uses: aws-actions/setup-sam@v2

      - name: Set up AWS creds
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ secrets.GH_ACTIONS_ROLE_ARN }}
          aws-region: eu-west-2

      - name: SAM Validate
        run: sam validate --region ${{ env.AWS_REGION }} -t deploy/template.yaml

      - name: SAM Build
        run: sam build --region ${{ env.AWS_REGION }} --config-env build -t deploy/template.yaml

      - name: Test with Checkov
        id: checkov
        uses: bridgecrewio/checkov-action@master
        with:
          file: ./.aws-sam/build/template.yaml
          framework: cloudformation

      - name: CloudFormation Lint
        uses: scottbrenner/cfn-lint-action@v2
        with:
          command: ./.aws-sam/build/template.yaml
