{% extends "common/layout/base.njk" %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "govuk/components/pagination/macro.njk" import govukPagination %}
{% set pageTitleName = 'pages.activityHistory.title' | translate %}
{% set paginationItems = [] %}
{% if pagination.items and pagination.currentPage %}
  {% set pageTitleName = [pageTitleName, " - ", 'pages.activityHistory.page' | translate | replace("[pageNumber]", pagination.currentPage)] | join %}
{% endif %}
{% set backLinkJS = true %}

{# set up data structure for pagination #}
{% for item in pagination.items %}
  {% set paginationItems = (paginationItems.push({
    number: item,
    href: "?page=" + item,
    current: true if (item == pagination.currentPage) else false
  }), paginationItems) %}
{% endfor %}

{% block content %}
  <div class="govuk-grid-row" id="activity-history" data-test-id="activity-history">
    <div class="govuk-grid-column-two-thirds">
      <h1 class="govuk-heading-l govuk-!-margin-top-0">{{ 'pages.activityHistory.header' | translate }}</h1>
      {% if data.length %} 
        <p class="govuk-body">{{ 'pages.activityHistory.explanation' | translate }}</p>
        <p class="govuk-body">{{ 'pages.activityHistory.notice' | translate | safe | replace("[changePassword]", changePasswordLink) }}</p>
      {% else %}
        {# Fallback in case there is no activity history â€“ this should never be visible as the fact that one is logged in and able to see this page means they should already have activity history on their account #}
        {{ govukInsetText({
          html: 'pages.activityHistory.empty' | translate | replace("[link]", contactLink)
        }) }}
      {% endif %}

      {% if data %}
        <ul class="activity-history__list">
          {%- for session in data -%}
            <h2 class="govuk-heading-s govuk-!-margin-top-3 govuk-!-margin-bottom-0">{{session[session.length-1].time}}</h2>
              <li class="activity-history__list-item">
                {% if session.length === 1 %}
                  <p class='govuk-body'>You visited {{ ['clientRegistry.', env, '.', session[0].visitedServiceId, '.header'] | join | translate }}</p>
                {% else %}
                  <p class='govuk-body'>You visited
                    <ul class='govuk-list govuk-list--bullet'>
                      {%- for event in session -%}
                      <li>{{ ['clientRegistry.', env, '.', event.visitedServiceId, '.header'] | join | translate }}</li>
                      {%- endfor -%}
                    </ul>
                  </p>
                {% endif %}
                <p class="govuk-body"><a class="govuk-link" href="{{event.reportSuspiciousActivityUrl}}">
                  {%- if session[0].reportedSuspicious -%}
                  {{ 'pages.activityHistory.reported' | translate | replace("[time]", session[0].reportedSuspiciousTime) }}
                  {%- else -%}
                  {{ 'pages.activityHistory.report' | translate | replace("[time]", session[0].time) }}
                  {%- endif -%}
                </a></p>
              </li>
          {%- endfor -%}
        </ul>
      {% endif %}

      {% if data.length and not pagination.nextPage %}
        {# if this is the last page of the activity log, show an explanatory paragraph #}
        {# the paragraph details when GOVUK One Login started showing activity history #}
        <p class="govuk-body" data-for-test="activity-log-explainer">{{ 'pages.activityHistory.featureIntro' | translate }}</p>
        <hr class="govuk-section-break govuk-section-break--m govuk-section-break--visible">
      {% endif %}

      {{ govukPagination({
        attributes: {
          "data-test-id": "activity-log-pagination"
        },
        landmarkLabel: "pages",
        previous: {
          href: "?page=" + pagination.previousPage
        } if pagination.previousPage,
        next: {
          href: "?page=" + pagination.nextPage
        } if pagination.nextPage,
        items: paginationItems
      }) if pagination.items }}
    </div>
  </div>
  {{ga4OnPageLoad({ nonce: scriptNonce,statusCode:"200",englishPageTitle:pageTitleName, taxonomyLevel1: "accounts", taxonomyLevel2:"home", contentId:"d61e09c3-5741-4cb9-aca6-d57f62fc3475",loggedInStatus:true,dynamic:true})}}
{% endblock %}
